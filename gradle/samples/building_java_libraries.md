# 构建 Java 库

2023-08-17, 13:23
@author Jiawei Mao
****

## 1. 简介

介绍如何使用 `gradle init` 创建一个 Java 库。

需要：

- 文本编辑器或 IDE，如 IntelliJ IDEA
- JDK8+
- gradle

## 2. 创建项目目录

Gradle 有一个名为 `init` 的内置任务，用于在一个空文件夹中初始化一个新的 Gradle 项目。`init` 任务使用另一个内置任务 `wrapper` 创建 Gradle wrapper 脚本 `gradlew`。

```powershell
$ mkdir demo
$ cd demo
```

## 3. 运行 init 任务

在创建的 demo 目录运行命令：

```sh
gradle init
```

出现提示时，选择 `3: library` 作为项目类型，选择 `3: Java` 为实现语言。然后选择编写脚本的 DSL：

- 1: Kotlin
- 2: Groovy

其它问题，点击回车使用默认值。

```powershell
> gradle init
Starting a Gradle Daemon (subsequent builds will be faster)

Select type of project to generate:
  1: basic
  2: application
  3: library
  4: Gradle plugin
Enter selection (default: basic) [1..4] 3

Select implementation language:
  1: C++
  2: Groovy
  3: Java
  4: Kotlin
  5: Scala
  6: Swift
Enter selection (default: Java) [1..6] 3

Select build script DSL:
  1: Kotlin
  2: Groovy
Enter selection (default: Kotlin) [1..2] 1

Select test framework:
  1: JUnit 4
  2: TestNG
  3: Spock
  4: JUnit Jupiter
Enter selection (default: JUnit Jupiter) [1..4] 4

Project name (default: demo):
Source package (default: demo):
Enter target version of Java (min. 7) (default: 17):
Generate build using new APIs and behavior (some features may change in the next minor release)? (default: no) [yes, no]


> Task :init
To learn more about Gradle by exploring our Samples at https://docs.gradle.org/8.2.1/samples/sample_building_java_libraries.html

BUILD SUCCESSFUL in 5m 35s
2 actionable tasks: 2 executed
```

`init` 任务生成的新项目结构如下：

- 选择 Kotlin 时的目录结构

@import "images/2023-08-16-16-22-00.png" {width="600px" title=""}

- 选择 Groovy 时的目录结构

@import "images/2023-08-16-16-23-22.png" {width="600px" title=""}

1. Generated folder for wrapper files
2. Gradle wrapper start scripts
3. Settings file to define build name and subprojects
4. Build script of lib project
5. Default Java source folder
6. Default Java test source folder

## 4. 检查项目文件

`settings.gradle(.kts)` 文件有两行重要的内容：

- Kotlin

```kotlin
rootProject.name = "demo"
include("lib")
```

- Groovy

```groovy
rootProject.name = 'demo'
include('lib')
```

- `rootProject.name` 为 build 分配一个名称，覆盖默认名称（所在目录名称）。建议设置一个固定名称，因为如果项目是共享的，文件夹名称可能改变。
- `include("lib")` 表示构建一个名为 lib 的子项目，包含实际的代码和构建逻辑。使用额外的 `include(...)` 语句添加更多子项目

这里构建一个名为 `lib` 的子项目。其配置文件为 `lib/build.gradle(.kts)`：

@import "images/2023-08-16-16-35-27.png" {width="600px" title=""}

@import "images/2023-08-16-16-35-55.png" {width="600px" title=""}

1. Apply the java-library plugin for API and implementation separation.
2. Use Maven Central for resolving dependencies.
3. Use JUnit Jupiter for testing.
4. This dependency is exported to consumers, that is to say found on their compile classpath.
5. This dependency is used internally, and not exposed to consumers on their own compile classpath.
6. Use JUnit Platform for unit tests.

生成的 `src/main/java/demo/Library.java` 文件内容：

```java
/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package demo;

public class Library {
    public boolean someLibraryMethod() {
        return true;
    }
}
```

生成的 `src/test/java/demo/Library.java` 文件内容：

```java
/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package demo;

import org.junit.jupiter.api.Test;
import static org.junit.jupiter.api.Assertions.*;

class LibraryTest {
    @Test void someLibraryMethodReturnsTrue() {
        Library classUnderTest = new Library();
        assertTrue(classUnderTest.someLibraryMethod(), "someLibraryMethod should return 'true'");
    }
}
```

生成的 test 类包含一个 Junit Jupiter 测试。

java-library 更多信息可以在其[文档](https://docs.gradle.org/current/userguide/java_library_plugin.html)查看。

## 5. 组装 library JAR

使用 `build` 任务构建项目。

可以使用 `gradle` 命令，但当项目包含 wrapper 时，建议使用 wrapper:

```gradle
$ ./gradlew build

BUILD SUCCESSFUL in 0s
4 actionable tasks: 4 executed
```

!!! tip
    第一次运行 wrapper 脚本 `gradlew` 时，会下载对应 gradle 版本并存储在本地 `~/.gradle/wrapper/dists` 目录，因此会较慢

第一次运行 `build`，Gradle 会检查 `~/.gradle` 目录下是否缓存所需的依赖。如果没有，则下载存储到这里。下次构建时，默认使用缓存的版本。`build` 任务编译类、运行测试，生成测试报告。

打开 `lib/build/reports/tests/test/index.html` 文件可以看到测试报告。

在 `lib/build/libs` 目录可以找到打包好的 JAR 文件 `lib.jar`。运行如下命令验证文件是否有效：

```powershell
> jar tf .\lib\build\libs\lib.jar
META-INF/
META-INF/MANIFEST.MF
demo/
demo/Library.class
```

应该能看到清单文件 `MANIFEST.MF` 和编译后的 `Library` 类。

!!! tip
    所有这些都不需要在构建脚本中进行任何额外的配置。因为 Gradle 的 java-library 插件假设项目源文件都按照[常规的项目布局](https://docs.gradle.org/current/userguide/java_plugin.html#sec:java_project_layout)。[自定义项目](https://docs.gradle.org/current/userguide/java_plugin.html#sec:changing_java_project_layout)布局方式。

到这里，就完成了创建 Java 库。

## 6. 自定义 library JAR

JAR 文件名称一般包含版本信息。可以通过在构建脚本中设置 version 属性实现：

- Kotlin

```kotlin
version = "0.1.0"
```

- Groovy

```groovy
version = '0.1.0'
```

!!! note
    除了版本，library 还需要 `name` 和 `group` 进行标识。其中 `name` 直接来着库的子项目名称。对本例就是 `lib`，可以通过修改 lib 目录名称和 `settings.gradle(.kts)` 文件中的 include(...) 语句进行修改。
    `group` 用于指定库的完整坐标。可以直接在 `settings.gradle(.kts)` 设置 `group` 属性，设置方法与 `version` 一样。

然后运行 `jar` 任务：

```powershell
> .\gradlew.bat jar

BUILD SUCCESSFUL in 3s
2 actionable tasks: 1 executed, 1 up-to-date
```

此时生成的 JAR 文件 `lib/build/libs/lib-0.1.0.jar` 包含版本信息。

另一个常见需求是定义清单（manifest）文件。下面通过配置 jar 任务，在清单文件中包含库的名称和版本。将以下内容添加到构建脚本的末尾：

- Kotlin

```kotlin
tasks.jar {
    manifest {
        attributes(mapOf("Implementation-Title" to project.name,
                         "Implementation-Version" to project.version))
    }
}
```

- Groovy

```groovy
tasks.named('jar') {
    manifest {
        attributes('Implementation-Title': project.name,
                   'Implementation-Version': project.version)
    }
}
```

为了确认修改成功，再次运行 `jar` 任务，同时把清单文件从 jar 包中解压：

```powershell
> .\gradlew.bat jar

BUILD SUCCESSFUL in 1s
2 actionable tasks: 1 executed, 1 up-to-date
> jar xf .\lib\build\libs\lib-0.1.0.jar META-INF/MANIFEST.MF
```

查看 `META-INF/MANIFEST.MF` 文件：

```mf
Manifest-Version: 1.0
Implementation-Title: lib
Implementation-Version: 0.1.0
```

## 7. 生成 sources JAR

生成 sources JAR 非常简单：

- Kotlin

```kotlin
java {
    withSourcesJar()
}
```

- Groovy

```groovy
java {
    withSourcesJar()
}
```

额外的 JAR 将作为 assemble 或 build 生命周期任务的一部分生成。生成的文件在 `lib/build/libs`。

## 8. 添加 API 文档

`java-library` 插件通过 `javadoc` 任务生成 Java API 文档。

init 插件生成的 `demo/Library.java` 已经包含了注释。

```java
/**
 * This Java source file was generated by the Gradle 'init' task.
 */
```

运行 javadoc 任务：

```powershell
> .\gradlew.bat javadoc

BUILD SUCCESSFUL in 1s
2 actionable tasks: 2 executed
```

打开 `lib/build/docs/javadoc/index.html` 文件可以看到生成的 `javadoc` 文件。

也可以生成 javadoc JAR 文件：

- build.gradle.kts

```kotlin
java {
    withJavadocJar()
}
```

- build.gradle

```groovy
java {
    withJavadocJar()
}
```

额外的 JAR 将作为 `assemble` 或 `build` 生命周期任务的一部分生成。生成的文件在 `lib/build/libs`。

## 9. Build Scan

了解 build 在幕后到底做了什么的最好方法使发布 [build scan](https://scans.gradle.com/)。只需运行 gradle 时添加 `--scan` flag 即可。

```gradle
$ ./gradlew build --scan

BUILD SUCCESSFUL in 0s
4 actionable tasks: 4 executed

Publishing a build scan to scans.gradle.com requires accepting the Gradle Terms of Service defined at https://gradle.com/terms-of-service.
Do you accept these terms? [yes, no] yes

Gradle Terms of Service accepted.

Publishing build scan...
https://gradle.com/s/5u4w3gxeurtd2
```

点击链接可以知道执行了哪些任务，从哪里下载了哪些依赖项更信息。

## 10. 总结

使用 Gradle 构建 Java 库：

- 初始化 Java 库项目
- 运行 build 查看测试报告
- 自定义 build 生成的 JAR 文件



